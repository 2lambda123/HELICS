FIND_PACKAGE(Java REQUIRED)
FIND_PACKAGE(JNI REQUIRED)
INCLUDE(UseJava)
INCLUDE(UseSWIG)
INCLUDE_DIRECTORIES(${JAVA_INCLUDE_PATH})
INCLUDE_DIRECTORIES(${JNI_INCLUDE_DIRS})

SET_PROPERTY(SOURCE ../helics.i PROPERTY SWIG_MODULE_NAME JNIhelics)

set(CMAKE_SWIG_FLAGS "-package;com.java.helics")
IF (${CMAKE_MAJOR_VERSION}.${CMAKE_MINOR_VERSION} VERSION_GREATER 3.7)
  SWIG_ADD_LIBRARY(JNIhelics TYPE MODULE LANGUAGE java SOURCES ../helics.i)
ELSE (${CMAKE_MAJOR_VERSION}.${CMAKE_MINOR_VERSION} VERSION_GREATER 3.7)
  SWIG_ADD_MODULE(JNIhelics java ../helics.i)
ENDIF (${CMAKE_MAJOR_VERSION}.${CMAKE_MINOR_VERSION} VERSION_GREATER 3.7)

SWIG_LINK_LIBRARIES(JNIhelics helicsSharedLib)
SWIG_LINK_LIBRARIES(JNIhelics ${JAVA_LIBRARIES})


set_target_properties (JNIhelics PROPERTIES FOLDER interfaces)

if (APPLE)

    # SET_TARGET_PROPERTIES(helicsSharedLib PROPERTIES MACOSX_RPATH TRUE)
    # SET_TARGET_PROPERTIES(helicsSharedLib PROPERTIES CMAKE_INSTALL_RPATH_USE_LINK_PATH TRUE)

    # SET_TARGET_PROPERTIES(_helics PROPERTIES MACOSX_RPATH TRUE)
    # SET_TARGET_PROPERTIES(_helics PROPERTIES CMAKE_INSTALL_RPATH_USE_LINK_PATH
    # SET_TARGET_PROPERTIES(helics PROPERTIES INSTALL_RPATH "@loader_path/../../..")

else()

    # SET_TARGET_PROPERTIES(_helics PROPERTIES INSTALL_RPATH "${CMAKE_INSTALL_PREFIX}/lib")
    # SET_TARGET_PROPERTIES(_helics PROPERTIES INSTALL_RPATH_USE_LINK_PATH TRUE)

endif()

configure_file(${PROJECT_SOURCE_DIR}/config/MakeJarCMakeLists.txt.in ${CMAKE_CURRENT_BINARY_DIR}/CMakeLists.txt @ONLY)

file(MAKE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/buildjar/)

# -D ADDITIONAL_JAR_FILES=$<TARGET_FILE:helicsSharedLib>;$<TARGET_FILE:JNIhelics>

ADD_CUSTOM_COMMAND(
    TARGET "JNIhelics" POST_BUILD
    COMMAND ${CMAKE_COMMAND} 
	ARGS ..
    WORKING_DIRECTORY "${CMAKE_CURRENT_BINARY_DIR}/buildjar"
	VERBATIM
)

ADD_CUSTOM_COMMAND(
    TARGET "JNIhelics" POST_BUILD
    COMMAND ${CMAKE_COMMAND} 
	ARGS  --build . --target helics
    WORKING_DIRECTORY "${CMAKE_CURRENT_BINARY_DIR}/buildjar/"
    COMMENT "Building jar file" 
	VERBATIM
)

INSTALL(FILES ${CMAKE_CURRENT_BINARY_DIR}/buildjar/helics.jar DESTINATION ${CMAKE_INSTALL_PREFIX}/java)
INSTALL(FILES $<TARGET_FILE:helicsSharedLib> DESTINATION ${CMAKE_INSTALL_PREFIX}/java)
INSTALL(TARGETS JNIhelics DESTINATION ${CMAKE_INSTALL_PREFIX}/java)
INSTALL(FILES ${KEY_LIBRARY_FILES} DESTINATION ${CMAKE_INSTALL_PREFIX}/java)